#!/bin/bash
#-
#- usage by cli,
#- sudo ./unbind_AD_then_bind_AD_again 1 2 3 ActiveDirectory_bind_credential Salt_for_ActiveDirectory_bind_credential ActiveDirectory_domain_name
#-
#- ActiveDirectory_bind_credential must be encrypted.
#-

IAM="$( whoami )"

function scriptLogging(){
    local logfile scriptname timestamp label mode
    logfile="/tmp/unbind_AD_then_bind_AD.log"
    scriptname="$( /usr/bin/basename "$0" )"
    timestamp="$( /bin/date "+%F %T" )"
    mode="$2"
    case "${mode:-1}" in
        2 )
            label="[error]"
            echo "$timestamp $scriptname $label $1" | /usr/bin/tee -a "$logfile"
            ;;
        * )
            label="[info]"
            echo "$timestamp $scriptname $label $1" | /usr/bin/tee -a "$logfile"
            ;;
    esac
}

function usage(){
    grep "^#-" "$0" | cut -c 4-
}

if [ "$IAM" != root ]; then
	usage ; exit 1
fi

credentialstring="$4"
salt="$5"
domaintobind="$6"

if [ -z "$credentialstring" ] || [ -z "$salt" ] || [ -z "$domaintobind" ]; then
    usage ; exit 1
else
    scriptLogging "credentialstring: $credentialstring"
    scriptLogging "salt: (I got it.)"
    scriptLogging "Domain to bind: $domaintobind"
fi

string="$( echo "$credentialstring" |  /usr/bin/openssl enc -aes256 -d -a -A -S "$salt" -k "$domaintobind" )"
if [ -z "$string" ]; then
    scriptLogging "Could not decrypt $credentialstring" 2
    exit 1
fi

ADADMIN="$( echo "$string" | awk '{print $1}')"
ADADMINPASS="$( echo "$string" | awk '{print $2}')"


computerName="$( dsconfigad -show | grep 'Computer Account' | awk '{print $NF}' | tr -d '$' )"
if [ -z "$computerName" ]; then
    # Jamf argument #2 is computer name.
    computerName="$2"
    bound=no
else
    bound=yes
fi

scriptLogging "ComputerID: $computerName"

systemsetup -setcomputername "$computerName"
systemsetup -setlocalsubnetname "$(echo "$computerName" | tr "[:upper:]" "[:lower:]")"

if [ "$bound" = yes ]; then
    logmsg="$(  dsconfigad -remove -username "${ADADMIN}" -password "${ADADMINPASS}" 2>&1 )"
    if [ -n "$logmsg" ]; then
        scriptLogging "$logmsg"
    fi
fi

dsconfigad -add "${ADDOMAIN}" \
            -username "${ADADMIN}" \
            -password "${ADADMINPASS}" \
            -computer "$computerName" 2>&1

dsconfigad -alldomains disable \
            -localhome enable \
            -mobile enable \
            -mobileconfirm disable \
            -namespace domain \
            -preferred "${ADDOMAIN}" \
            -restrictDDNS en99 \
            -enablesso 2>&1
